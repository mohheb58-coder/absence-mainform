<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨ Ù…Ø¯Ø±Ø³Ù‡ Ø´Ù‡ÛŒØ¯ Ù†ÛŒØ§Ø³Ø±ÛŒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Tahoma, Arial, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #FF6B6B 0%, #FFE66D 25%, #4ECDC4 50%, #95E1D3 75%, #FF6B9D 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        @keyframes gradientShift {
            0% { transform: scale(1.0); background-position: 0% 50%; }
            50% { transform: scale(1.0); background-position: 100% 50%; }
            100% { transform: scale(1.0); background-position: 0% 50%; }
        }
        .container {
            background: #ffffff; 
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            border: 3px solid rgba(255, 255, 255, 0.5);
            max-height: 90vh;
            overflow-y: auto;
        }
        h1, h2 {
            color: #FF6B6B;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            font-size: 28px;
        }
        .btn {
            background: linear-gradient(135deg, #FF6B9D 0%, #C06C84 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            width: calc(50% - 20px);
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.4);
            font-weight: bold;
        }
        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.6);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }
        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.6);
        }
        .btn-success {
            background: linear-gradient(135deg, #FFE66D 0%, #FFA500 100%);
            box-shadow: 0 5px 15px rgba(255, 230, 109, 0.4);
            color: #333;
        }
        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(255, 230, 109, 0.6);
        }
        .btn-danger {
            background: linear-gradient(135deg, #FF6B6B 0%, #C92A2A 100%);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
        }
        .btn-small {
            width: auto;
            padding: 10px 20px;
            font-size: 14px;
        }
        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
        .hidden {
            display: none !important;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }
        select, input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .select-row {
            display: flex;
            gap: 15px;
        }
        .select-row .form-group {
            flex: 1;
        }
        .student-list {
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .student-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .student-name {
            flex: 1;
            font-size: 14px;
        }
        .emoji-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .emoji-btn:hover {
            transform: scale(1.2);
        }
        .emoji-btn.absent {
            filter: grayscale(100%);
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FF6B9D;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .class-header {
            background: linear-gradient(135deg, #FF6B9D 0%, #C06C84 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
            font-size: 18px;
            border-bottom: 4px solid #A0506C;
        }
        .absence-list {
            padding: 10px 20px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 15px;
            border-right: 4px solid #FF6B9D;
        }
        .no-absence {
            padding: 15px 20px;
            background: #d4edda;
            border-radius: 8px;
            margin-bottom: 15px;
            color: #155724;
            font-weight: bold;
            text-align: center;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-right: 4px solid #FF6B9D;
        }
        .stat-card h3 {
            color: #FF6B6B;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }
        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .bar-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bar-label {
            min-width: 150px;
            font-size: 14px;
        }
        .bar-visual {
            flex: 1;
            height: 30px;
            background: linear-gradient(135deg, #FF6B9D 0%, #C06C84 100%);
            border-radius: 5px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            color: white;
            font-weight: bold;
        }
        .date-input {
            cursor: pointer;
            background: white !important;
        }
        .date-picker-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .date-picker-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 350px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            margin: auto;
        }
        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .date-picker-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .date-btn {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
        }
        .date-btn:hover {
            background: #FF6B9D;
            color: white;
            border-color: #FF6B9D;
        }
        .delete-student-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            margin: 8px 0;
            border-right: 4px solid #FF6B9D;
        }
        .delete-student-info {
            flex: 1;
        }
        .delete-btn-small {
            background: linear-gradient(135deg, #FF6B6B 0%, #C92A2A 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        .delete-btn-small:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.5);
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-content h3 {
            color: #FF6B6B;
            margin-bottom: 20px;
        }
        .modal-content p {
            margin-bottom: 25px;
            color: #555;
            line-height: 1.6;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .delete-absence-btn {
            background: linear-gradient(135deg, #FF6B6B 0%, #C92A2A 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            margin: 5px 0;
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.4);
        }
        .delete-absence-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.6);
        }
    </style>
</head>
<body>
    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ§ÛŒÛŒØ¯ Ø­Ø°Ù -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3>âš ï¸ ØªØ§ÛŒÛŒØ¯ Ø­Ø°Ù</h3>
            <p id="confirmMessage"></p>
            <div class="modal-buttons">
                <button class="btn btn-danger btn-small" onclick="confirmDelete()">Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ø´ÙˆØ¯</button>
                <button class="btn btn-secondary btn-small" onclick="closeConfirmModal()">Ø§Ù†ØµØ±Ø§Ù</button>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ù‡Ø´Ø¯Ø§Ø± ØªØ¹Ø·ÛŒÙ„ÛŒ -->
    <div id="holidayModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“… Ù‡Ø´Ø¯Ø§Ø± ØªØ¹Ø·ÛŒÙ„ÛŒ</h3>
            <p>Ø§Ù…Ø±ÙˆØ² <span id="dayName"></span> Ø§Ø³Øª Ùˆ Ù…Ø¯Ø±Ø³Ù‡ ØªØ¹Ø·ÛŒÙ„ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯.<br><br>Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ù¾Ù†Ù„ Ø´ÙˆÛŒØ¯ØŸ</p>
            <div class="modal-buttons">
                <button class="btn btn-success btn-small" onclick="proceedToTeacherPanel()">Ø¨Ù„Ù‡ØŒ ÙˆØ§Ø±Ø¯ Ø´ÙˆÙ…</button>
                <button class="btn btn-secondary btn-small" onclick="closeHolidayModal()">Ø§Ù†ØµØ±Ø§Ù</button>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® -->
    <div id="datePickerModal" class="date-picker-modal">
        <div class="date-picker-content">
            <div class="date-picker-header">
                <h3 style="margin: 0; color: #FF6B6B;">Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®</h3>
                <button onclick="closeDatePicker()" style="background: none; border: none; font-size: 24px; cursor: pointer;">Ã—</button>
            </div>
            <div class="form-group">
                <label>Ø³Ø§Ù„:</label>
                <select id="yearSelect" onchange="updateMonthPicker()">
                    <option value="1403">1403</option>
                    <option value="1404">1404</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ù…Ø§Ù‡:</label>
                <div class="date-picker-grid" id="monthGrid"></div>
            </div>
            <div class="form-group">
                <label>Ø±ÙˆØ²:</label>
                <div class="date-picker-grid" id="dayGrid"></div>
            </div>
        </div>
    </div>

    <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ -->
    <div class="container">
        <!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ -->
        <div id="homePage">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <img src="https://i.ibb.co/rGr1Fx6J/image.jpg" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #FF6B9D; box-shadow: 0 5px 15px rgba(0,0,0,0.3); object-fit: cover;" alt="Ø´Ù‡ÛŒØ¯ Ø­Ø³Ù† Ù†ÛŒØ§Ø³Ø±ÛŒ">
                <div style="flex: 1; text-align: center;">
                    <h1 style="margin: 0;">Ø³ÛŒØ³ØªÙ… Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨</h1>
                    <h2 style="margin: 10px 0;">Ù…Ø¯Ø±Ø³Ù‡ Ø´Ù‡ÛŒØ¯ Ù†ÛŒØ§Ø³Ø±ÛŒ</h2>
                </div>
                <img src="https://i.ibb.co/LD1m3s5k/image.jpg" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #FF6B9D; box-shadow: 0 5px 15px rgba(0,0,0,0.3); object-fit: cover;" alt="Ø´Ù‡ÛŒØ¯ Ø­Ø³Ù† Ù†ÛŒØ§Ø³Ø±ÛŒ">
            </div>
            <div class="button-group">
                <button class="btn" onclick="checkHolidayAndShowTeacher()">ÙˆØ±ÙˆØ¯ Ù…Ø¹Ù„Ù…</button>
                <button class="btn btn-secondary" onclick="showManagerLogin()">ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±</button>
            </div>
        </div>

        <!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ± -->
        <div id="managerLogin" class="hidden">
            <h2>ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±</h2>
            <div class="form-group">
                <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:</label>
                <input type="password" id="managerPassword" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
            </div>
            <div id="loginError" class="message error hidden">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!</div>
            <div class="button-group">
                <button class="btn btn-success" onclick="checkManagerPassword()">ÙˆØ±ÙˆØ¯</button>
                <button class="btn btn-secondary btn-small" onclick="showHome()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>

        <!-- Ù¾Ù†Ù„ Ù…Ø¹Ù„Ù… -->
        <div id="teacherPanel" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <img src="https://i.ibb.co/rGr1Fx6J/image.jpg" style="width: 70px; height: 70px; border-radius: 50%; border: 3px solid #FF6B9D; box-shadow: 0 5px 15px rgba(0,0,0,0.3); object-fit: cover;" alt="Ø´Ù‡ÛŒØ¯ Ø­Ø³Ù† Ù†ÛŒØ§Ø³Ø±ÛŒ">
                <h2 style="margin: 0; flex: 1; text-align: center;">Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨ Ù…Ø¯Ø±Ø³Ù‡ Ø´Ù‡ÛŒØ¯ Ù†ÛŒØ§Ø³Ø±ÛŒ</h2>
                <img src="https://i.ibb.co/LD1m3s5k/image.jpg" style="width: 70px; height: 70px; border-radius: 50%; border: 3px solid #FF6B9D; box-shadow: 0 5px 15px rgba(0,0,0,0.3); object-fit: cover;" alt="Ø´Ù‡ÛŒØ¯ Ø­Ø³Ù† Ù†ÛŒØ§Ø³Ø±ÛŒ">
            </div>
            <div class="select-row">
                <div class="form-group">
                    <label>Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§ÛŒÙ‡:</label>
                    <select id="gradeSelect" onchange="loadStudents()">
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                        <option value="Ø§ÙˆÙ„">Ø§ÙˆÙ„</option>
                        <option value="Ø¯ÙˆÙ…">Ø¯ÙˆÙ…</option>
                        <option value="Ø³ÙˆÙ…">Ø³ÙˆÙ…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„Ø§Ø³:</label>
                    <select id="classSelect" onchange="loadStudents()">
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Ù†Ø§Ù… Ù…Ø¹Ù„Ù…:</label>
                <input type="text" id="teacherName" placeholder="Ù†Ø§Ù… Ù…Ø¹Ù„Ù…" readonly style="background: #f0f0f0;">
            </div>
            <div id="classInfo" class="message info hidden" style="text-align: center;">
                ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†: <span id="studentCount">0</span> Ù†ÙØ±
            </div>
            <div id="studentList" class="student-list"></div>
            <div id="teacherMessage" class="hidden"></div>
            <div class="button-group">
                <button class="btn" onclick="noAbsent()" id="noAbsentBtn">ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…</button>
                <button class="btn btn-success" onclick="submitAbsence()" id="submitBtn">Ø«Ø¨Øª ØºÛŒØ¨Øª</button>
                <button class="btn btn-secondary btn-small" onclick="showHome()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <!-- Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª -->
        <div id="managerPanel" class="hidden">
            <h2>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            <div class="button-group">
                <button class="btn" onclick="showDailyReport()">Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²</button>
                <button class="btn" onclick="showFullReport()">Ú¯Ø²Ø§Ø±Ø´ Ú©Ù„</button>
                <button class="btn btn-secondary" onclick="showSearchPanel()">Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</button>
                <button class="btn" onclick="showStatistics()">Ø¢Ù…Ø§Ø± Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø±</button>
                <button class="btn btn-success" onclick="showAddStudent()">Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</button>
                <button class="btn btn-danger" onclick="showDeleteStudent()">Ø­Ø°Ù Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</button>
                <button class="btn btn-secondary btn-small" onclick="showHome()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <!-- Ù¾Ù†Ù„ Ø­Ø°Ù Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² -->
        <div id="deleteStudentPanel" class="hidden">
            <h2>Ø­Ø°Ù Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</h2>
            <div class="form-group">
                <label>Ø¬Ø³ØªØ¬Ùˆ:</label>
                <input type="text" id="deleteSearchInput" placeholder="Ù†Ø§Ù… ÛŒØ§ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²" oninput="filterDeleteList()">
            </div>
            <div class="select-row">
                <div class="form-group">
                    <label>Ù¾Ø§ÛŒÙ‡:</label>
                    <select id="deleteGradeFilter" onchange="filterDeleteList()">
                        <option value="">Ù‡Ù…Ù‡</option>
                        <option value="Ø§ÙˆÙ„">Ø§ÙˆÙ„</option>
                        <option value="Ø¯ÙˆÙ…">Ø¯ÙˆÙ…</option>
                        <option value="Ø³ÙˆÙ…">Ø³ÙˆÙ…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ú©Ù„Ø§Ø³:</label>
                    <select id="deleteClassFilter" onchange="filterDeleteList()">
                        <option value="">Ù‡Ù…Ù‡</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>
            </div>
            <div id="deleteStudentList" class="student-list"></div>
            <div id="deleteMessage" class="hidden"></div>
            <div class="button-group">
                <button class="btn btn-secondary btn-small" onclick="showManagerPanel()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>

        <!-- Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ² -->
        <div id="dailyReport" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <img src="https://i.ibb.co/rGr1Fx6J/image.jpg" style="width: 70px; height: 70px; border-radius: 50%; border: 3px solid #FF6B9D; box-shadow: 0 5px 15px rgba(0,0,0,0.3); object-fit: cover;" alt="Ø´Ù‡ÛŒØ¯ Ø­Ø³Ù† Ù†ÛŒØ§Ø³Ø±ÛŒ">
                <h2 style="margin: 0; flex: 1; text-align: center;">Ú¯Ø²Ø§Ø±Ø´ ØºÛŒØ¨Øª Ø§Ù…Ø±ÙˆØ²</h2>
                <img src="https://i.ibb.co/LD1m3s5k/image.jpg" style="width: 70px; height: 70px; border-radius: 50%; border: 3px solid #FF6B9D; box-shadow: 0 5px 15px rgba(0,0,0,0.3); object-fit: cover;" alt="Ø´Ù‡ÛŒØ¯ Ø­Ø³Ù† Ù†ÛŒØ§Ø³Ø±ÛŒ">
            </div>
            <div id="dailyReportDate" style="text-align: center; color: #FF6B6B; font-weight: bold; font-size: 16px; margin-bottom: 15px;"></div>
            <div id="dailyReportContent"></div>
            <div class="button-group">
                <button class="btn btn-success btn-small" onclick="copyDailyReport()">Ú©Ù¾ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒØ§</button>
                <button class="btn btn-secondary btn-small" onclick="showManagerPanel()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>

        <!-- Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ -->
        <div id="fullReport" class="hidden">
            <h2>Ú¯Ø²Ø§Ø±Ø´ Ú©Ù„</h2>
            <div class="select-row">
                <div class="form-group">
                    <label>Ø§Ø² ØªØ§Ø±ÛŒØ®:</label>
                    <input type="text" id="fromDate" class="date-input" placeholder="1403/08/01" readonly onclick="showDatePicker('fromDate')">
                </div>
                <div class="form-group">
                    <label>ØªØ§ ØªØ§Ø±ÛŒØ®:</label>
                    <input type="text" id="toDate" class="date-input" placeholder="1403/08/30" readonly onclick="showDatePicker('toDate')">
                </div>
            </div>
            <button class="btn btn-success" onclick="loadFullReport()">Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´</button>
            <div id="fullReportContent"></div>
            <div class="button-group">
                <button class="btn btn-secondary btn-small" onclick="showManagerPanel()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>

        <!-- Ù¾Ù†Ù„ Ø¬Ø³ØªØ¬Ùˆ -->
        <div id="searchPanel" class="hidden">
            <h2>Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</h2>
            <div class="form-group">
                <label>Ø¬Ø³ØªØ¬Ùˆ:</label>
                <input type="text" id="searchName" placeholder="Ù†Ø§Ù… ÛŒØ§ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²" oninput="filterSearchResults()">
            </div>
            <div class="select-row">
                <div class="form-group">
                    <label>Ù¾Ø§ÛŒÙ‡:</label>
                    <select id="searchGrade" onchange="filterSearchResults()">
                        <option value="">Ù‡Ù…Ù‡</option>
                        <option value="Ø§ÙˆÙ„">Ø§ÙˆÙ„</option>
                        <option value="Ø¯ÙˆÙ…">Ø¯ÙˆÙ…</option>
                        <option value="Ø³ÙˆÙ…">Ø³ÙˆÙ…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ú©Ù„Ø§Ø³:</label>
                    <select id="searchClass" onchange="filterSearchResults()">
                        <option value="">Ù‡Ù…Ù‡</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>
            </div>
            <div class="select-row">
                <div class="form-group">
                    <label>Ø§Ø² ØªØ§Ø±ÛŒØ®:</label>
                    <input type="text" id="searchFromDate" class="date-input" placeholder="1403/08/01" readonly onclick="showDatePicker('searchFromDate')">
                </div>
                <div class="form-group">
                    <label>ØªØ§ ØªØ§Ø±ÛŒØ®:</label>
                    <input type="text" id="searchToDate" class="date-input" placeholder="1403/08/30" readonly onclick="showDatePicker('searchToDate')">
                </div>
            </div>
            <button class="btn btn-success" onclick="filterSearchResults()">Ø¬Ø³ØªØ¬Ùˆ</button>
            <div id="searchResult" class="student-list" style="margin-top: 20px;"></div>
            <div class="button-group">
                <button class="btn btn-secondary btn-small" onclick="showManagerPanel()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>

        <!-- Ù¾Ù†Ù„ Ø¢Ù…Ø§Ø± Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø± -->
        <div id="statisticsPanel" class="hidden">
            <h2>Ø¢Ù…Ø§Ø± Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø± ØºÛŒØ¨Øªâ€ŒÙ‡Ø§</h2>
            <div class="select-row">
                <div class="form-group">
                    <label>Ø§Ø² ØªØ§Ø±ÛŒØ®:</label>
                    <input type="text" id="statFromDate" class="date-input" placeholder="1403/08/01" readonly onclick="showDatePicker('statFromDate')">
                </div>
                <div class="form-group">
                    <label>ØªØ§ ØªØ§Ø±ÛŒØ®:</label>
                    <input type="text" id="statToDate" class="date-input" placeholder="1403/08/30" readonly onclick="showDatePicker('statToDate')">
                </div>
            </div>
            <button class="btn btn-success" onclick="loadStatistics()">Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±</button>
            <button class="btn" onclick="exportToExcel()">Ø®Ø±ÙˆØ¬ÛŒ Excel</button>
            <div id="statisticsContent"></div>
            <div class="button-group">
                <button class="btn btn-secondary btn-small" onclick="showManagerPanel()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>

        <!-- Ù¾Ù†Ù„ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² -->
        <div id="addStudentPanel" class="hidden">
            <h2>Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</h2>
            <div class="form-group">
                <label>Ù†Ø§Ù…:</label>
                <input type="text" id="newStudentName">
            </div>
            <div class="form-group">
                <label>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</label>
                <input type="text" id="newStudentFamily">
            </div>
            <div class="form-group">
                <label>Ù¾Ø§ÛŒÙ‡:</label>
                <select id="newStudentGrade">
                    <option value="Ø§ÙˆÙ„">Ø§ÙˆÙ„</option>
                    <option value="Ø¯ÙˆÙ…">Ø¯ÙˆÙ…</option>
                    <option value="Ø³ÙˆÙ…">Ø³ÙˆÙ…</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ú©Ù„Ø§Ø³:</label>
                <select id="newStudentClass">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ù…Ø¹Ù„Ù…:</label>
                <input type="text" id="newStudentTeacher" placeholder="Ù†Ø§Ù… Ù…Ø¹Ù„Ù… (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
            </div>
            <div id="addStudentMessage" class="hidden"></div>
            <div class="button-group">
                <button class="btn btn-success" onclick="addStudent()">Ø«Ø¨Øª</button>
                <button class="btn btn-secondary btn-small" onclick="showManagerPanel()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>
    </div>

    <script>
        // URL API Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª
        const SHEET_URL = 'https://script.google.com/macros/s/AKfycbwygevr4OTNo3VRn0832c5_qxvfzGVRERqCpTUxRa_zot1nX60Xk1r89kdPcnScrlm-bg/exec';
        
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ
        let students = [];
        let currentAbsent = new Set();
        let currentStatistics = null;
        let currentDatePickerTarget = null;
        window.pendingDeletion = null;

        // Ù…Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø³ÛŒ
        const persianMonths = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†', 'Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª', 'Ø®Ø±Ø¯Ø§Ø¯', 'ØªÛŒØ±', 'Ù…Ø±Ø¯Ø§Ø¯', 'Ø´Ù‡Ø±ÛŒÙˆØ±', 
                              'Ù…Ù‡Ø±', 'Ø¢Ø¨Ø§Ù†', 'Ø¢Ø°Ø±', 'Ø¯ÛŒ', 'Ø¨Ù‡Ù…Ù†', 'Ø§Ø³ÙÙ†Ø¯'];
        
        // Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡
        const persianDays = ['ÛŒÚ©Ø´Ù†Ø¨Ù‡', 'Ø¯ÙˆØ´Ù†Ø¨Ù‡', 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡', 'Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡', 'Ø¬Ù…Ø¹Ù‡', 'Ø´Ù†Ø¨Ù‡'];

        // ØªØ¹Ø·ÛŒÙ„Ø§Øª Ø±Ø³Ù…ÛŒ
        const officialHolidays = [
            '1403/01/01', '1403/01/02', '1403/01/03', '1403/01/04', // Ø¹ÛŒØ¯ Ù†ÙˆØ±ÙˆØ²
            '1403/01/12', '1403/01/13', // Ø±ÙˆØ² Ø¬Ù…Ù‡ÙˆØ±ÛŒ Ø§Ø³Ù„Ø§Ù…ÛŒ
            '1403/03/14', '1403/03/15', // Ø±Ø­Ù„Øª Ø­Ø¶Ø±Øª Ø§Ù…Ø§Ù…
            '1403/04/14', // Ù‚ÛŒØ§Ù… 15 Ø®Ø±Ø¯Ø§Ø¯
            '1403/06/03', '1403/06/04', // Ø¹ÛŒØ¯ ÙØ·Ø±
            '1403/08/10', '1403/08/11', // Ø¹ÛŒØ¯ Ù‚Ø±Ø¨Ø§Ù†
            '1403/08/18', // Ø¹ÛŒØ¯ ØºØ¯ÛŒØ±
            '1403/10/20', // ØªØ§Ø³ÙˆØ¹Ø§
            '1403/10/21', // Ø¹Ø§Ø´ÙˆØ±Ø§
            '1403/12/29', // Ø´Ù‡Ø§Ø¯Øª Ù¾ÛŒØ§Ù…Ø¨Ø±
            '1404/01/01', '1404/01/02', '1404/01/03', '1404/01/04', // Ø¹ÛŒØ¯ Ù†ÙˆØ±ÙˆØ²
        ];

        // Ø¨Ø±Ø±Ø³ÛŒ ØªØ¹Ø·ÛŒÙ„ÛŒ Ø±Ø³Ù…ÛŒ
        function isOfficialHoliday(date) {
            const normalizedDate = date.replace(/\//g, '/');
            return officialHolidays.includes(normalizedDate);
        }

        // Ø¨Ø±Ø±Ø³ÛŒ ØªØ¹Ø·ÛŒÙ„ÛŒ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ Ù…Ø¹Ù„Ù…
        function checkHolidayAndShowTeacher() {
            const today = new Date().toLocaleDateString('fa-IR');
            
            // Ø¨Ø±Ø±Ø³ÛŒ ØªØ¹Ø·ÛŒÙ„Ø§Øª Ø±Ø³Ù…ÛŒ
            if (isOfficialHoliday(today)) {
                document.getElementById('dayName').textContent = 'ØªØ¹Ø·ÛŒÙ„ Ø±Ø³Ù…ÛŒ';
                document.getElementById('holidayModal').querySelector('p').textContent = 
                    'Ø§Ù…Ø±ÙˆØ² ØªØ¹Ø·ÛŒÙ„Ø§Øª Ø±Ø³Ù…ÛŒ Ø§Ø³Øª Ùˆ Ù…Ø¯Ø±Ø³Ù‡ ØªØ¹Ø·ÛŒÙ„ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯.\n\nØ¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ù¾Ù†Ù„ Ø´ÙˆÛŒØ¯ØŸ';
                document.getElementById('holidayModal').style.display = 'flex';
                return;
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡ Ùˆ Ø¬Ù…Ø¹Ù‡
            if (isHoliday()) {
                const dayName = getPersianDayOfWeek();
                document.getElementById('dayName').textContent = dayName;
                document.getElementById('holidayModal').querySelector('p').textContent = 
                    `Ø§Ù…Ø±ÙˆØ² ${dayName} Ø§Ø³Øª Ùˆ Ù…Ø¯Ø±Ø³Ù‡ ØªØ¹Ø·ÛŒÙ„ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯.\n\nØ¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ù¾Ù†Ù„ Ø´ÙˆÛŒØ¯ØŸ`;
                document.getElementById('holidayModal').style.display = 'flex';
            } else {
                showTeacherPanel();
            }
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        window.addEventListener('load', () => {
            fetchStudents();
            initializeDatePicker();
        });

        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ù†ØªØ®Ø§Ø¨Ú¯Ø± ØªØ§Ø±ÛŒØ®
        function initializeDatePicker() {
            const monthGrid = document.getElementById('monthGrid');
            persianMonths.forEach((month, index) => {
                const btn = document.createElement('button');
                btn.className = 'date-btn';
                btn.textContent = month;
                btn.onclick = () => selectMonth(index + 1);
                monthGrid.appendChild(btn);
            });
        }

        // Ù†Ù…Ø§ÛŒØ´ Ø§Ù†ØªØ®Ø§Ø¨Ú¯Ø± ØªØ§Ø±ÛŒØ®
        function showDatePicker(targetId) {
            currentDatePickerTarget = targetId;
            document.getElementById('datePickerModal').style.display = 'flex';
            updateMonthPicker();
        }

        // Ø¨Ø³ØªÙ† Ø§Ù†ØªØ®Ø§Ø¨Ú¯Ø± ØªØ§Ø±ÛŒØ®
        function closeDatePicker() {
            document.getElementById('datePickerModal').style.display = 'none';
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ù†ØªØ®Ø§Ø¨Ú¯Ø± Ù…Ø§Ù‡
        function updateMonthPicker() {
            document.getElementById('dayGrid').innerHTML = '';
        }

        // Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø§Ù‡
        function selectMonth(month) {
            const dayGrid = document.getElementById('dayGrid');
            dayGrid.innerHTML = '';
            
            const daysInMonth = month <= 6 ? 31 : (month <= 11 ? 30 : 29);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const btn = document.createElement('button');
                btn.className = 'date-btn';
                btn.textContent = day;
                btn.onclick = () => selectDay(month, day);
                dayGrid.appendChild(btn);
            }
        }

        // Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ²
        function selectDay(month, day) {
            const year = document.getElementById('yearSelect').value;
            const formattedDate = `${year}/${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}`;
            
            document.getElementById(currentDatePickerTarget).value = formattedDate;
            closeDatePicker();
        }

        // Ø¯Ø±ÛŒØ§ÙØª Ø±ÙˆØ² Ù‡ÙØªÙ‡ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ
        function getPersianDayOfWeek() {
            const now = new Date();
            return persianDays[now.getDay()];
        }

        // Ø¨Ø±Ø±Ø³ÛŒ ØªØ¹Ø·ÛŒÙ„ÛŒ (Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡ Ùˆ Ø¬Ù…Ø¹Ù‡)
        function isHoliday() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            return dayOfWeek === 4 || dayOfWeek === 5; // Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡ = 4, Ø¬Ù…Ø¹Ù‡ = 5
        }

        // Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¹Ù„Ù…
        function proceedToTeacherPanel() {
            closeHolidayModal();
            showTeacherPanel();
        }

        // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø·ÛŒÙ„ÛŒ
        function closeHolidayModal() {
            document.getElementById('holidayModal').style.display = 'none';
        }

        // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ API
        async function callAPI(action, data = {}) {
            try {
                const response = await fetch(SHEET_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({action, ...data})
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±:', error);
                return {success: false, message: 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±'};
            }
        }

        // Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†
        async function fetchStudents() {
            const result = await callAPI('getStudents');
            if (result.success && result.data) {
                students = result.data;
            }
        }

        // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
        function showHome() {
            hideAll();
            document.getElementById('homePage').classList.remove('hidden');
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ Ù…Ø¹Ù„Ù…
        function showTeacherPanel() {
            hideAll();
            document.getElementById('teacherPanel').classList.remove('hidden');
        }

        // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±
        function showManagerLogin() {
            hideAll();
            document.getElementById('managerLogin').classList.remove('hidden');
            document.getElementById('managerPassword').value = '';
            document.getElementById('loginError').classList.add('hidden');
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª
        function showManagerPanel() {
            hideAll();
            document.getElementById('managerPanel').classList.remove('hidden');
        }

        // Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²
        function showDailyReport() {
            hideAll();
            document.getElementById('dailyReport').classList.remove('hidden');
            loadDailyReport();
        }

        // Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„
        function showFullReport() {
            hideAll();
            document.getElementById('fullReport').classList.remove('hidden');
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ Ø¬Ø³ØªØ¬Ùˆ
        function showSearchPanel() {
            hideAll();
            document.getElementById('searchPanel').classList.remove('hidden');
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ Ø¢Ù…Ø§Ø±
        function showStatistics() {
            hideAll();
            document.getElementById('statisticsPanel').classList.remove('hidden');
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
        function showAddStudent() {
            hideAll();
            document.getElementById('addStudentPanel').classList.remove('hidden');
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ Ø­Ø°Ù Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
        function showDeleteStudent() {
            hideAll();
            document.getElementById('deleteStudentPanel').classList.remove('hidden');
            loadDeleteStudentList();
        }

        // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ØµÙØ­Ø§Øª
        function hideAll() {
            const pages = ['homePage', 'managerLogin', 'teacherPanel', 'managerPanel', 
                          'dailyReport', 'fullReport', 'searchPanel', 'addStudentPanel', 
                          'statisticsPanel', 'deleteStudentPanel'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
        }

        // Ø¨Ø±Ø±Ø³ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù…Ø¯ÛŒØ±
        function checkManagerPassword() {
            const password = document.getElementById('managerPassword').value;
            if (password === '2225') {
                showManagerPanel();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†
        function loadStudents() {
            const grade = document.getElementById('gradeSelect').value;
            const classNum = document.getElementById('classSelect').value;
            
            if (!grade || !classNum) return;

            const filtered = students.filter(s => s.grade === grade && s.class === classNum);
            filtered.sort((a, b) => a.family.localeCompare(b.family, 'fa'));
            
            const listDiv = document.getElementById('studentList');
            currentAbsent.clear();
            
            getClassInfo(grade, classNum);
            
            if (filtered.length === 0) {
                listDiv.innerHTML = '<p class="message info">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ú©Ù„Ø§Ø³ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
                return;
            }
            
            listDiv.innerHTML = filtered.map((s, i) => `
                <div class="student-item">
                    <span class="student-name">${i + 1}. ${s.name} ${s.family}</span>
                    <button class="emoji-btn" id="emoji${i}" onclick="toggleAbsent(${i}, '${s.name}', '${s.family}')">ğŸ™‹â€â™‚ï¸</button>
                </div>
            `).join('');
        }

        // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„Ø§Ø³
        async function getClassInfo(grade, classNum) {
            const result = await callAPI('getClassInfo', {grade, class: classNum});
            
            if (result.success && result.data) {
                const teacherInput = document.getElementById('teacherName');
                const classInfo = document.getElementById('classInfo');
                const studentCount = document.getElementById('studentCount');
                
                teacherInput.value = result.data.teacher || '';
                studentCount.textContent = result.data.studentCount;
                classInfo.classList.remove('hidden');
            }
        }

        // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª ØºÛŒØ¨Øª
        function toggleAbsent(index, name, family) {
            const btn = document.getElementById('emoji' + index);
            const key = name + ' ' + family;
            
            if (currentAbsent.has(key)) {
                currentAbsent.delete(key);
                btn.textContent = 'ğŸ™‹â€â™‚ï¸';
                btn.classList.remove('absent');
            } else {
                currentAbsent.add(key);
                btn.textContent = 'ğŸ™';
                btn.classList.add('absent');
            }
        }

        // Ø«Ø¨Øª Ø¹Ø¯Ù… ØºÛŒØ¨Øª
        async function noAbsent() {
            const grade = document.getElementById('gradeSelect').value;
            const classNum = document.getElementById('classSelect').value;
            const teacher = document.getElementById('teacherName').value;

            if (!grade || !classNum || !teacher) {
                showMessage('teacherMessage', 'Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            document.getElementById('noAbsentBtn').disabled = true;
            document.getElementById('submitBtn').disabled = true;

            const today = new Date().toLocaleDateString('fa-IR');
            const checkResult = await callAPI('checkDuplicateSubmission', {
                date: today,
                grade: grade,
                class: classNum
            });

            if (checkResult.data && checkResult.data.isDuplicate) {
                showMessage('teacherMessage', 'Ú©Ù„Ø§Ø³ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡ØŒ Ø¨Ø§ Ù…Ø¯ÛŒØ± Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ú©Ù†ÛŒØ¯', 'error');
                document.getElementById('noAbsentBtn').disabled = false;
                document.getElementById('submitBtn').disabled = false;
                return;
            }

            const result = await callAPI('submitAbsence', {
                date: today,
                grade: grade,
                class: classNum,
                teacher: teacher,
                time: new Date().toLocaleTimeString('fa-IR'),
                students: []
            });

            if (result.success) {
                showMessage('teacherMessage', 'ØºÛŒØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ (ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…) âœ…', 'success');
                setTimeout(() => {
                    showHome();
                }, 2000);
            } else {
                showMessage('teacherMessage', result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª', 'error');
                document.getElementById('noAbsentBtn').disabled = false;
                document.getElementById('submitBtn').disabled = false;
            }
        }

        // Ø«Ø¨Øª ØºÛŒØ¨Øª
        async function submitAbsence() {
            const grade = document.getElementById('gradeSelect').value;
            const classNum = document.getElementById('classSelect').value;
            const teacher = document.getElementById('teacherName').value;

            if (!grade || !classNum || !teacher) {
                showMessage('teacherMessage', 'Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            if (currentAbsent.size === 0) {
                showMessage('teacherMessage', 'Ù„Ø·ÙØ§ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† ØºØ§ÛŒØ¨ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯ ÛŒØ§ "ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…" Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            document.getElementById('noAbsentBtn').disabled = true;
            document.getElementById('submitBtn').disabled = true;

            const today = new Date().toLocaleDateString('fa-IR');
            const checkResult = await callAPI('checkDuplicateSubmission', {
                date: today,
                grade: grade,
                class: classNum
            });

            if (checkResult.data && checkResult.data.isDuplicate) {
                showMessage('teacherMessage', 'Ú©Ù„Ø§Ø³ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡ØŒ Ø¨Ø§ Ù…Ø¯ÛŒØ± Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ú©Ù†ÛŒØ¯', 'error');
                document.getElementById('noAbsentBtn').disabled = false;
                document.getElementById('submitBtn').disabled = false;
                return;
            }

            const result = await callAPI('submitAbsence', {
                date: today,
                grade: grade,
                class: classNum,
                teacher: teacher,
                time: new Date().toLocaleTimeString('fa-IR'),
                students: Array.from(currentAbsent)
            });

            if (result.success) {
                showMessage('teacherMessage', 'ØºÛŒØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ âœ…', 'success');
                setTimeout(() => {
                    showHome();
                }, 2000);
            } else {
                showMessage('teacherMessage', result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª', 'error');
                document.getElementById('noAbsentBtn').disabled = false;
                document.getElementById('submitBtn').disabled = false;
            }
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
        function showMessage(elementId, text, type) {
            const msg = document.getElementById(elementId);
            msg.textContent = text;
            msg.className = 'message ' + type;
            msg.classList.remove('hidden');
        }

        // Ø­Ø°Ù ØºÛŒØ¨Øª
        async function deleteAbsence(grade, classNum, date) {
            const confirmMessage = `Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØºÛŒØ¨Øª Ù¾Ø§ÛŒÙ‡ ${grade} Ú©Ù„Ø§Ø³ ${classNum} Ø±Ø§ Ø¯Ø± ØªØ§Ø±ÛŒØ® ${date} Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ`;
            
            document.getElementById('confirmMessage').textContent = confirmMessage;
            document.getElementById('confirmModal').style.display = 'flex';
            
            window.pendingDeletion = {
                grade: grade,
                classNum: classNum,
                date: date
            };
        }

        // ØªØ§ÛŒÛŒØ¯ Ø­Ø°Ù Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
        function confirmDeleteStudent(name, family, grade, classNum) {
            const confirmMessage = `Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ "${name} ${family}" Ø§Ø² Ù¾Ø§ÛŒÙ‡ ${grade} Ú©Ù„Ø§Ø³ ${classNum} Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ`;
            
            document.getElementById('confirmMessage').textContent = confirmMessage;
            document.getElementById('confirmModal').style.display = 'flex';
            
            window.pendingDeletion = {
                name: name,
                family: family,
                grade: grade,
                class: classNum
            };
        }

        // ØªØ§ÛŒÛŒØ¯ Ø­Ø°Ù
        async function confirmDelete() {
            const modal = document.getElementById('confirmModal');
            modal.style.display = 'none';
            
            if (!window.pendingDeletion) {
                return;
            }
            
            // Ø­Ø°Ù ØºÛŒØ¨Øª
            if (window.pendingDeletion.grade && window.pendingDeletion.classNum && window.pendingDeletion.date) {
                const { grade, classNum, date } = window.pendingDeletion;
                const result = await callAPI('deleteAbsence', {
                    grade: grade,
                    class: classNum,
                    date: date
                });
                
                if (result.success) {
                    alert('ØºÛŒØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯ âœ…');
                    loadDailyReport(); // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ú¯Ø²Ø§Ø±Ø´
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ØºÛŒØ¨Øª: ' + (result.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'));
                }
            }
            // Ø­Ø°Ù Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
            else if (window.pendingDeletion.name && window.pendingDeletion.family) {
                const { name, family, grade, class: classNum } = window.pendingDeletion;
                const result = await callAPI('deleteStudent', {
                    name: name,
                    family: family,
                    grade: grade,
                    class: classNum
                });

                if (result.success) {
                    showMessage('deleteMessage', 'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯ âœ…', 'success');
                    
                    students = students.filter(s => 
                        !(s.name === name && 
                          s.family === family && 
                          s.grade === grade && 
                          s.class === classNum)
                    );
                    
                    filterDeleteList();
                    
                    setTimeout(() => {
                        document.getElementById('deleteMessage').classList.add('hidden');
                    }, 3000);
                } else {
                    showMessage('deleteMessage', result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²', 'error');
                }
            }
            
            window.pendingDeletion = null;
        }

        // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ ØªØ§ÛŒÛŒØ¯
        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            window.pendingDeletion = null;
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²
        async function loadDailyReport() {
            const contentDiv = document.getElementById('dailyReportContent');
            const dateDiv = document.getElementById('dailyReportDate');
            contentDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p></div>';

            const today = new Date().toLocaleDateString('fa-IR');
            dateDiv.textContent = `ğŸ“… ØªØ§Ø±ÛŒØ®: ${today}`;
            
            const result = await callAPI('getDailyAbsences', {date: today});

            if (!result.success || !result.data || result.data.length === 0) {
                contentDiv.innerHTML = '<p class="message info">Ø§Ù…Ø±ÙˆØ² ØºÛŒØ¨ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
                return;
            }

            const todayAbsences = result.data;
            todayAbsences.sort((a, b) => {
                const gradeOrder = {Ø§ÙˆÙ„: 1, Ø¯ÙˆÙ…: 2, Ø³ÙˆÙ…: 3};
                if (gradeOrder[a.grade] !== gradeOrder[b.grade]) {
                    return gradeOrder[a.grade] - gradeOrder[b.grade];
                }
                return parseInt(a.class) - parseInt(b.class);
            });

            let html = '';
            
            todayAbsences.forEach((a) => {
                const genderIcon = a.teacher.includes('Ø®Ø§Ù†Ù…') || a.teacher.includes('ÙØ§Ø·Ù…Ù‡') || 
                                  a.teacher.includes('Ø²Ù‡Ø±Ø§') || a.teacher.includes('Ù…Ø±ÛŒÙ…') || 
                                  a.teacher.includes('Ø³Ø§Ø±Ø§') || a.teacher.includes('Ù…ÛŒÙ†Ø§') || 
                                  a.teacher.includes('Ù†Ø±Ú¯Ø³') || a.teacher.includes('Ø§Ù„Ù‡Ø§Ù…') ? 'ğŸ‘©â€ğŸ«' : 'ğŸ‘¨â€ğŸ«';
                
                html += `<div class="class-header">Ù¾Ø§ÛŒÙ‡ ${a.grade} Ú©Ù„Ø§Ø³ ${a.class} - ${genderIcon} ${a.teacher} - â° Ø³Ø§Ø¹Øª ${a.time}</div>`;
                
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù
                html += `<div style="text-align: left; margin: 10px 0;">
                            <button class="delete-absence-btn" onclick="deleteAbsence('${a.grade}', '${a.class}', '${a.date}')">
                                ğŸ—‘ï¸ Ø­Ø°Ù Ø§ÛŒÙ† Ø«Ø¨Øª ØºÛŒØ¨Øª
                            </button>
                         </div>`;
                
                if (a.students.length > 0) {
                    html += `<div class="absence-list">`;
                    a.students.forEach((s, i) => {
                        html += `<div style="padding: 5px 0;">${i + 1}. ${s}</div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div class="no-absence">âœ… ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…</div>`;
                }
            });
            
            const totalAbsent = todayAbsences.reduce((sum, a) => sum + a.students.length, 0);
            html += `<div style="background: #FFE66D; padding: 15px; border-radius: 10px; 
                     text-align: center; font-weight: bold; margin-top: 20px; font-size: 18px;">`;
            html += `ğŸ“Š Ø¬Ù…Ø¹ Ú©Ù„ ØºØ§ÛŒØ¨ÛŒÙ†: ${totalAbsent} Ù†ÙØ±`;
            html += `</div>`;

            contentDiv.innerHTML = html;
        }

        // Ú©Ù¾ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²
        async function copyDailyReport() {
            const today = new Date().toLocaleDateString('fa-IR');
            const result = await callAPI('getDailyAbsences', {date: today});
            
            if (!result.success || !result.data || result.data.length === 0) {
                alert('Ú¯Ø²Ø§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
                return;
            }

            const todayAbsences = result.data;
            todayAbsences.sort((a, b) => {
                const gradeOrder = {Ø§ÙˆÙ„: 1, Ø¯ÙˆÙ…: 2, Ø³ÙˆÙ…: 3};
                if (gradeOrder[a.grade] !== gradeOrder[b.grade]) {
                    return gradeOrder[a.grade] - gradeOrder[b.grade];
                }
                return parseInt(a.class) - parseInt(b.class);
            });
            
            let text = `Ú¯Ø²Ø§Ø±Ø´ ØºÛŒØ¨Øª Ù…Ø¯Ø±Ø³Ù‡ Ø´Ù‡ÛŒØ¯ Ù†ÛŒØ§Ø³Ø±ÛŒ\n`;
            text += `ØªØ§Ø±ÛŒØ®: ${today}\n`;
            text += `${'â”€'.repeat(30)}\n\n`;
            
            let totalAbsent = 0;
            let classCount = 0;
            
            todayAbsences.forEach((a) => {
                classCount++;
                const genderIcon = a.teacher.includes('Ø®Ø§Ù†Ù…') ? 'ğŸ‘©â€ğŸ«' : 'ğŸ‘¨â€ğŸ«';
                
                text += `Ù¾Ø§ÛŒÙ‡ ${a.grade} Ú©Ù„Ø§Ø³ ${a.class} ${genderIcon} ${a.teacher}\n`;
                
                if (a.students.length > 0) {
                    totalAbsent += a.students.length;
                    a.students.forEach((s, i) => {
                        text += `  ${i + 1}. ${s}\n`;
                    });
                } else {
                    text += `  âœ… ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…\n`;
                }
                
                if (classCount < todayAbsences.length) {
                    text += `${'â”€'.repeat(20)}\n`;
                }
            });
            
            text += `\n${'â”€'.repeat(30)}\n`;
            text += `Ø¬Ù…Ø¹ Ú©Ù„ ØºØ§ÛŒØ¨ÛŒÙ†: ${totalAbsent} Ù†ÙØ±`;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('âœ… Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù¾ÛŒ Ø´Ø¯!');
                }).catch(err => {
                    fallbackCopyText(text);
                });
            } else {
                fallbackCopyText(text);
            }
        }

        // Ú©Ù¾ÛŒ Ù…ØªÙ† Ø¨Ù‡ Ú©Ù„ÛŒÙ¾â€ŒØ¨ÙˆØ±Ø¯ (Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ)
        function fallbackCopyText(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert('âœ… Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø§ÙˆÙ„ÛŒØ§ Ú©Ù¾ÛŒ Ø´Ø¯!');
            } catch (err) {
                alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†');
            }
            document.body.removeChild(textArea);
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„
        async function loadFullReport() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const contentDiv = document.getElementById('fullReportContent');

            if (!fromDate || !toDate) {
                contentDiv.innerHTML = '<p class="message error">Ù„Ø·ÙØ§ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>';
                return;
            }

            contentDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p></div>';

            const result = await callAPI('getAbsencesByDate', {
                fromDate: fromDate,
                toDate: toDate
            });

            if (!result.success || !result.data || result.data.length === 0) {
                contentDiv.innerHTML = '<p class="message info">Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ ØºÛŒØ¨ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
                return;
            }

            let html = '';
            
            result.data.forEach((a) => {
                const genderIcon = a.teacher.includes('Ø®Ø§Ù†Ù…') || a.teacher.includes('ÙØ§Ø·Ù…Ù‡') || 
                                  a.teacher.includes('Ø²Ù‡Ø±Ø§') || a.teacher.includes('Ù…Ø±ÛŒÙ…') || 
                                  a.teacher.includes('Ø³Ø§Ø±Ø§') || a.teacher.includes('Ù…ÛŒÙ†Ø§') || 
                                  a.teacher.includes('Ù†Ø±Ú¯Ø³') || a.teacher.includes('Ø§Ù„Ù‡Ø§Ù…') ? 'ğŸ‘©â€ğŸ«' : 'ğŸ‘¨â€ğŸ«';
                
                html += `<div class="class-header">${a.date} - Ù¾Ø§ÛŒÙ‡ ${a.grade} Ú©Ù„Ø§Ø³ ${a.class} - ${genderIcon} ${a.teacher} - Ø³Ø§Ø¹Øª ${a.time}</div>`;
                
                if (a.students.length > 0) {
                    html += `<div class="absence-list">`;
                    a.students.forEach((s, i) => {
                        html += `<div style="padding: 5px 0;">${i + 1}. ${s}</div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div class="no-absence">âœ… ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…</div>`;
                }
            });

            contentDiv.innerHTML = html;
        }

        // Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
        async function advancedSearch() {
            const searchName = document.getElementById('searchName').value.trim();
            const searchGrade = document.getElementById('searchGrade').value;
            const searchClass = document.getElementById('searchClass').value;
            const searchFromDate = document.getElementById('searchFromDate').value;
            const searchToDate = document.getElementById('searchToDate').value;
            const resultDiv = document.getElementById('searchResult');

            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...</p></div>';

            const result = await callAPI('advancedSearch', {
                name: searchName,
                grade: searchGrade,
                classNum: searchClass,
                fromDate: searchFromDate,
                toDate: searchToDate
            });

            if (!result.success || !result.data || result.data.length === 0) {
                resultDiv.innerHTML = '<p class="message info">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
                return;
            }

            let html = `<div class="stat-card">`;
            html += `<h3>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ (${result.data.length} Ù…ÙˆØ±Ø¯)</h3>`;
            html += '<div style="line-height: 1.8;">';
            
            result.data.forEach((a, i) => {
                html += `<div style="padding: 10px; background: #f9f9f9; 
                         border-radius: 8px; margin: 10px 0; border-right: 4px solid #FF6B9D;">`;
                html += `<strong>${i + 1}.</strong> ${a.name} - Ù¾Ø§ÛŒÙ‡ ${a.grade} Ú©Ù„Ø§Ø³ ${a.class}<br>`;
                html += `ØªØ§Ø±ÛŒØ®: ${a.date} - Ù…Ø¹Ù„Ù…: ${a.teacher}`;
                html += `</div>`;
            });
            
            html += '</div></div>';
            resultDiv.innerHTML = html;
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø±
        async function loadStatistics() {
            const fromDate = document.getElementById('statFromDate').value;
            const toDate = document.getElementById('statToDate').value;
            const contentDiv = document.getElementById('statisticsContent');

            if (!fromDate || !toDate) {
                contentDiv.innerHTML = '<p class="message error">Ù„Ø·ÙØ§ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>';
                return;
            }

            contentDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p></div>';

            const result = await callAPI('getAbsenceStatistics', {
                fromDate: fromDate,
                toDate: toDate
            });

            if (!result.success || !result.data) {
                contentDiv.innerHTML = '<p class="message error">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø±</p>';
                return;
            }

            currentStatistics = result.data;
            displayStatistics(result.data);
        }

        // Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±
        function displayStatistics(data) {
            const contentDiv = document.getElementById('statisticsContent');
            let html = '';

            if (data.students && data.students.length > 0) {
                html += `<div class="stat-card">`;
                html += `<h3>ğŸ”´ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† ØºÛŒØ¨Øª</h3>`;
                html += `<div class="bar-chart">`;
                
                const topStudents = data.students.slice(0, 10);
                const maxCount = topStudents[0].count;
                
                topStudents.forEach((s, i) => {
                    const width = (s.count / maxCount) * 100;
                    html += `<div class="bar-item">`;
                    html += `<div class="bar-label">${i + 1}. ${s.name}</div>`;
                    html += `<div class="bar-visual" style="width: ${width}%">${s.count} Ø±ÙˆØ²</div>`;
                    html += `</div>`;
                });
                
                html += `</div></div>`;
            }

            if (data.classes && data.classes.length > 0) {
                html += `<div class="stat-card">`;
                html += `<h3>ğŸ“Š Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† ØºÛŒØ¨Øª</h3>`;
                html += `<div class="bar-chart">`;
                
                const maxClassCount = data.classes[0].count;
                
                data.classes.forEach((c, i) => {
                    const width = (c.count / maxClassCount) * 100;
                    html += `<div class="bar-item">`;
                    html += `<div class="bar-label">${i + 1}. Ù¾Ø§ÛŒÙ‡ ${c.grade} Ú©Ù„Ø§Ø³ ${c.class}</div>`;
                    html += `<div class="bar-visual" style="width: ${width}%">${c.count} Ù†ÙØ±</div>`;
                    html += `</div>`;
                });
                
                html += `</div></div>`;
            }

            if ((!data.students || data.students.length === 0) && (!data.classes || data.classes.length === 0)) {
                html = '<p class="message info">Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ ØºÛŒØ¨ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
            }

            contentDiv.innerHTML = html;
        }

        // Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„
        function exportToExcel() {
            if (!currentStatistics || !currentStatistics.students || currentStatistics.students.length === 0) {
                alert('Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ Ø¢Ù…Ø§Ø± Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯');
                return;
            }

            let csv = '\ufeff';
            csv += 'Ø±Ø¯ÛŒÙ,Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ,Ù¾Ø§ÛŒÙ‡,Ú©Ù„Ø§Ø³,ØªØ¹Ø¯Ø§Ø¯ ØºÛŒØ¨Øª\n';
            
            currentStatistics.students.forEach((s, index) => {
                csv += `${index + 1},"${s.name}",${s.grade},${s.class},${s.count}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Ø¢Ù…Ø§Ø±_ØºÛŒØ¨Øª_${new Date().toLocaleDateString('fa-IR').replace(/\//g, '-')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('âœ… ÙØ§ÛŒÙ„ Excel Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
        }

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
        async function addStudent() {
            const name = document.getElementById('newStudentName').value.trim();
            const family = document.getElementById('newStudentFamily').value.trim();
            const grade = document.getElementById('newStudentGrade').value;
            const classNum = document.getElementById('newStudentClass').value;
            const teacher = document.getElementById('newStudentTeacher').value.trim();

            if (!name || !family) {
                showMessage('addStudentMessage', 'Ù„Ø·ÙØ§ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            const result = await callAPI('addStudent', {
                name: name,
                family: family,
                grade: grade,
                class: classNum,
                teacher: teacher
            });

            if (result.success) {
                showMessage('addStudentMessage', 'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ âœ…', 'success');
                
                students.push({name, family, grade, class: classNum, teacher});
                
                document.getElementById('newStudentName').value = '';
                document.getElementById('newStudentFamily').value = '';
                document.getElementById('newStudentTeacher').value = '';
                
                setTimeout(() => {
                    document.getElementById('addStudentMessage').classList.add('hidden');
                }, 3000);
            } else {
                showMessage('addStudentMessage', result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª', 'error');
            }
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø­Ø°Ù Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
        async function loadDeleteStudentList() {
            await fetchStudents();
            filterDeleteList();
        }

        // ÙÛŒÙ„ØªØ± Ù„ÛŒØ³Øª Ø­Ø°Ù Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
        function filterDeleteList() {
            const searchTerm = document.getElementById('deleteSearchInput').value.toLowerCase();
            const gradeFilter = document.getElementById('deleteGradeFilter').value;
            const classFilter = document.getElementById('deleteClassFilter').value;
            
            let filtered = students.filter(s => {
                const fullName = `${s.name} ${s.family}`.toLowerCase();
                const matchName = !searchTerm || fullName.includes(searchTerm);
                const matchGrade = !gradeFilter || s.grade === gradeFilter;
                const matchClass = !classFilter || s.class === classFilter;
                
                return matchName && matchGrade && matchClass;
            });

            filtered.sort((a, b) => {
                const gradeOrder = {Ø§ÙˆÙ„: 1, Ø¯ÙˆÙ…: 2, Ø³ÙˆÙ…: 3};
                if (gradeOrder[a.grade] !== gradeOrder[b.grade]) {
                    return gradeOrder[a.grade] - gradeOrder[b.grade];
                }
                if (parseInt(a.class) !== parseInt(b.class)) {
                    return parseInt(a.class) - parseInt(b.class);
                }
                return a.family.localeCompare(b.family, 'fa');
            });

            const listDiv = document.getElementById('deleteStudentList');
            
            if (filtered.length === 0) {
                listDiv.innerHTML = '<p class="message info">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
                return;
            }

            listDiv.innerHTML = filtered.map((s, i) => `
                <div class="delete-student-item">
                    <div class="delete-student-info">
                        <strong>${i + 1}. ${s.name} ${s.family}</strong><br>
                        <span style="color: #666; font-size: 13px;">Ù¾Ø§ÛŒÙ‡ ${s.grade} - Ú©Ù„Ø§Ø³ ${s.class}${s.teacher ? ' - Ù…Ø¹Ù„Ù…: ' + s.teacher : ''}</span>
                    </div>
                    <button class="delete-btn-small" onclick="confirmDeleteStudent('${s.name}', '${s.family}', '${s.grade}', '${s.class}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </div>
            `).join('');
        }

        // ========== ØªÙˆØ§Ø¨Ø¹ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ ========== //

        // ÙÛŒÙ„ØªØ± Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ
        async function filterSearchResults() {
            const searchName = document.getElementById('searchName').value.trim().toLowerCase();
            const searchGrade = document.getElementById('searchGrade').value;
            const searchClass = document.getElementById('searchClass').value;
            const searchFromDate = document.getElementById('searchFromDate').value;
            const searchToDate = document.getElementById('searchToDate').value;

            const resultDiv = document.getElementById('searchResult');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...</p></div>';

            const result = await callAPI('advancedSearch', {
                name: searchName,
                grade: searchGrade,
                classNum: searchClass,
                fromDate: searchFromDate,
                toDate: searchToDate
            });

            if (!result.success || !result.data || result.data.length === 0) {
                resultDiv.innerHTML = '<p class="message info">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
                return;
            }

            displaySearchResults(result.data);
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ
        function displaySearchResults(results) {
            const resultDiv = document.getElementById('searchResult');
            
            let html = `<div class="stat-card">
                <h3>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ (${results.length} Ù…ÙˆØ±Ø¯)</h3>`;
            
            // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù†ØªØ§ÛŒØ¬ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
            const groupedResults = groupResultsByStudent(results);
            
            Object.keys(groupedResults).forEach((studentKey, index) => {
                const studentData = groupedResults[studentKey];
                const totalAbsences = studentData.absences.length;
                
                html += `
                <div class="delete-student-item">
                    <div class="delete-student-info">
                        <strong>${index + 1}. ${studentData.name}</strong><br>
                        <span style="color: #666; font-size: 13px;">
                            Ù¾Ø§ÛŒÙ‡ ${studentData.grade} - Ú©Ù„Ø§Ø³ ${studentData.class}
                            ${studentData.teacher ? ' - Ù…Ø¹Ù„Ù…: ' + studentData.teacher : ''}
                        </span><br>
                        <span style="color: #FF6B6B; font-size: 12px; font-weight: bold;">
                            ğŸ“… ØªØ¹Ø¯Ø§Ø¯ ØºÛŒØ¨Øª: ${totalAbsences} Ø±ÙˆØ²
                        </span>
                    </div>
                    <button class="btn-small" onclick="showStudentAbsenceDetails('${studentData.name}', '${studentData.grade}', '${studentData.class}')" 
                            style="background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%); color: white; border: none; padding: 8px 16px; border-radius: 15px; cursor: pointer;">
                        ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª
                    </button>
                </div>`;
            });
            
            html += `</div>`;
            resultDiv.innerHTML = html;
        }

        // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù†ØªØ§ÛŒØ¬ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
        function groupResultsByStudent(results) {
            const grouped = {};
            
            results.forEach((item, index) => {
                const studentKey = `${item.name}_${item.grade}_${item.class}`;
                
                if (!grouped[studentKey]) {
                    grouped[studentKey] = {
                        name: item.name,
                        grade: item.grade,
                        class: item.class,
                        teacher: item.teacher,
                        absences: []
                    };
                }
                
                grouped[studentKey].absences.push({
                    date: item.date,
                    time: item.time
                });
            });
            
            return grouped;
        }

        // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª ØºÛŒØ¨Øªâ€ŒÙ‡Ø§ÛŒ ÛŒÚ© Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
        function showStudentAbsenceDetails(studentName, grade, classNum) {
            const searchName = document.getElementById('searchName').value.trim().toLowerCase();
            const searchGrade = document.getElementById('searchGrade').value;
            const searchClass = document.getElementById('searchClass').value;
            const searchFromDate = document.getElementById('searchFromDate').value;
            const searchToDate = document.getElementById('searchToDate').value;

            // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…Ø¬Ø¯Ø¯ API Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª
            callAPI('advancedSearch', {
                name: studentName.split(' ')[0], // ÙÙ‚Ø· Ù†Ø§Ù… Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±
                grade: searchGrade || grade,
                classNum: searchClass || classNum,
                fromDate: searchFromDate,
                toDate: searchToDate
            }).then(result => {
                if (result.success && result.data) {
                    const studentAbsences = result.data.filter(item => 
                        `${item.name}`.toLowerCase().includes(studentName.toLowerCase())
                    );
                    
                    displayStudentDetails(studentName, studentAbsences);
                }
            });
        }

        // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª ÛŒÚ© Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
        function displayStudentDetails(studentName, absences) {
            let html = `<div style="background: white; padding: 15px; border-radius: 10px; margin: 10px 0; border-right: 4px solid #4ECDC4;">
                <h4 style="color: #FF6B6B; margin-bottom: 15px;">ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª ØºÛŒØ¨Øªâ€ŒÙ‡Ø§ÛŒ ${studentName}</h4>`;
            
            if (absences.length === 0) {
                html += `<p class="message info">ØºÛŒØ¨ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>`;
            } else {
                html += `<div style="max-height: 300px; overflow-y: auto;">`;
                
                absences.forEach((absence, index) => {
                    html += `
                    <div style="padding: 8px; margin: 5px 0; background: #f9f9f9; border-radius: 5px; border-right: 3px solid #FF6B9D;">
                        <strong>${index + 1}.</strong> 
                        ğŸ“… ${absence.date} 
                        â° ${absence.time}
                        <br>
                        <span style="color: #666; font-size: 12px;">
                            Ù¾Ø§ÛŒÙ‡ ${absence.grade} - Ú©Ù„Ø§Ø³ ${absence.class} - ${absence.teacher}
                        </span>
                    </div>`;
                });
                
                html += `</div>`;
            }
            
            html += `<button onclick="closeStudentDetails()" 
                      style="margin-top: 10px; background: #FF6B6B; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                Ø¨Ø³ØªÙ†
            </button>
            </div>`;
            
            document.getElementById('searchResult').innerHTML = html;
        }

        // Ø¨Ø³ØªÙ† Ø¬Ø²Ø¦ÛŒØ§Øª
        function closeStudentDetails() {
            filterSearchResults(); // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª Ø§ØµÙ„ÛŒ
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù†ØªØ§ÛŒØ¬
        async function loadSearchResults() {
            await filterSearchResults();
        }
        
        // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
        document.addEventListener('DOMContentLoaded', showHome);
    </script>
</body>
</html>
