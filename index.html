<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Tahoma, Arial, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #FF6B6B 0%, #FFE66D 25%, #4ECDC4 50%, #95E1D3 75%, #FF6B9D 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.5);
        }
        h1, h2 {
            color: #FF6B6B;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            font-size: 28px;
        }
        .btn {
            background: linear-gradient(135deg, #FF6B9D 0%, #C06C84 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            width: calc(50% - 20px);
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.4);
            font-weight: bold;
        }
        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.6);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }
        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.6);
        }
        .btn-success {
            background: linear-gradient(135deg, #FFE66D 0%, #FFA500 100%);
            box-shadow: 0 5px 15px rgba(255, 230, 109, 0.4);
            color: #333;
        }
        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(255, 230, 109, 0.6);
        }
        .btn-small {
            width: auto;
            padding: 10px 20px;
            font-size: 14px;
        }
        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
        .hidden {
            display: none !important;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }
        select, input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .select-row {
            display: flex;
            gap: 15px;
        }
        .select-row .form-group {
            flex: 1;
        }
        .student-list {
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .student-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .student-name {
            flex: 1;
            font-size: 14px;
        }
        .emoji-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .emoji-btn:hover {
            transform: scale(1.2);
        }
        .emoji-btn.absent {
            filter: grayscale(100%);
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FF6B9D;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ -->
        <div id="homePage">
            <h1>Ø³ÛŒØ³ØªÙ… Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨</h1>
            <h2>Ù…Ø¯Ø±Ø³Ù‡ Ø´Ù‡ÛŒØ¯ Ù†ÛŒØ§Ø³Ø±ÛŒ</h2>
            <div class="button-group">
                <button class="btn" onclick="showTeacherPanel()">ÙˆØ±ÙˆØ¯ Ù…Ø¹Ù„Ù…</button>
                <button class="btn btn-secondary" onclick="showManagerLogin()">ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±</button>
            </div>
        </div>

        <!-- Ù¾Ù†Ù„ ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ± -->
        <div id="managerLogin" class="hidden">
            <h2>ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±</h2>
            <div class="form-group">
                <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:</label>
                <input type="password" id="managerPassword" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
            </div>
            <div id="loginError" class="message error hidden">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!</div>
            <div class="button-group">
                <button class="btn btn-success" onclick="checkManagerPassword()">ÙˆØ±ÙˆØ¯</button>
                <button class="btn btn-secondary btn-small" onclick="showHome()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>

        <!-- Ù¾Ù†Ù„ Ù…Ø¹Ù„Ù… -->
        <div id="teacherPanel" class="hidden">
            <h2>Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨ Ù…Ø¯Ø±Ø³Ù‡ Ø´Ù‡ÛŒØ¯ Ù†ÛŒØ§Ø³Ø±ÛŒ</h2>
            <div class="select-row">
                <div class="form-group">
                    <label>Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§ÛŒÙ‡:</label>
                    <select id="gradeSelect" onchange="loadStudents()">
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                        <option value="Ø§ÙˆÙ„">Ø§ÙˆÙ„</option>
                        <option value="Ø¯ÙˆÙ…">Ø¯ÙˆÙ…</option>
                        <option value="Ø³ÙˆÙ…">Ø³ÙˆÙ…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„Ø§Ø³:</label>
                    <select id="classSelect" onchange="loadStudents()">
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Ù†Ø§Ù… Ù…Ø¹Ù„Ù…:</label>
                <input type="text" id="teacherName" placeholder="Ù†Ø§Ù… Ù…Ø¹Ù„Ù…" readonly style="background: #f0f0f0;">
            </div>
            <div id="classInfo" class="message info hidden" style="text-align: center;">
                ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†: <span id="studentCount">0</span> Ù†ÙØ±
            </div>
            <div id="studentList" class="student-list"></div>
            <div id="teacherMessage" class="hidden"></div>
            <div class="button-group">
                <button class="btn" onclick="noAbsent()" id="noAbsentBtn">ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…</button>
                <button class="btn btn-success" onclick="submitAbsence()" id="submitBtn">Ø«Ø¨Øª ØºÛŒØ¨Øª</button>
                <button class="btn btn-secondary btn-small" onclick="showHome()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <!-- Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ± -->
        <div id="managerPanel" class="hidden">
            <h2>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            <div class="button-group">
                <button class="btn" onclick="showDailyReport()">Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²</button>
                <button class="btn" onclick="showFullReport()">Ú¯Ø²Ø§Ø±Ø´ Ú©Ù„</button>
                <button class="btn btn-secondary" onclick="showSearchPanel()">Ø¬Ø³ØªØ¬ÙˆÛŒ ØºØ§ÛŒØ¨ÛŒÙ†</button>
                <button class="btn btn-success" onclick="showAddStudent()">Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</button>
                <button class="btn btn-secondary btn-small" onclick="showHome()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <!-- Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ² -->
        <div id="dailyReport" class="hidden">
            <h2>Ú¯Ø²Ø§Ø±Ø´ ØºÛŒØ¨Øª Ø§Ù…Ø±ÙˆØ²</h2>
            <div id="dailyReportContent"></div>
            <div class="button-group">
                <button class="btn btn-success btn-small" onclick="copyReport()">Ú©Ù¾ÛŒ Ú¯Ø²Ø§Ø±Ø´</button>
                <button class="btn btn-secondary btn-small" onclick="showManagerPanel()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>

        <!-- Ú¯Ø²Ø§Ø±Ø´ Ú©Ù„ -->
        <div id="fullReport" class="hidden">
            <h2>Ú¯Ø²Ø§Ø±Ø´ Ú©Ù„</h2>
            <div class="select-row">
                <div class="form-group">
                    <label>Ø§Ø² ØªØ§Ø±ÛŒØ®:</label>
                    <input type="date" id="fromDate">
                </div>
                <div class="form-group">
                    <label>ØªØ§ ØªØ§Ø±ÛŒØ®:</label>
                    <input type="date" id="toDate">
                </div>
            </div>
            <button class="btn btn-success" onclick="loadFullReport()">Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´</button>
            <div id="fullReportContent"></div>
            <div class="button-group">
                <button class="btn btn-secondary btn-small" onclick="showManagerPanel()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>

        <!-- Ø¬Ø³ØªØ¬ÙˆÛŒ ØºØ§ÛŒØ¨ÛŒÙ† -->
        <div id="searchPanel" class="hidden">
            <h2>Ø¬Ø³ØªØ¬ÙˆÛŒ ØºØ§ÛŒØ¨ÛŒÙ†</h2>
            <div class="form-group">
                <label>Ù†Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²:</label>
                <input type="text" id="searchName" placeholder="Ù†Ø§Ù… ÛŒØ§ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
            </div>
            <button class="btn btn-success" onclick="searchStudent()">Ø¬Ø³ØªØ¬Ùˆ</button>
            <div id="searchResult"></div>
            <div class="button-group">
                <button class="btn btn-secondary btn-small" onclick="showManagerPanel()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>

        <!-- Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² -->
        <div id="addStudentPanel" class="hidden">
            <h2>Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</h2>
            <div class="form-group">
                <label>Ù†Ø§Ù…:</label>
                <input type="text" id="newStudentName">
            </div>
            <div class="form-group">
                <label>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</label>
                <input type="text" id="newStudentFamily">
            </div>
            <div class="form-group">
                <label>Ù¾Ø§ÛŒÙ‡:</label>
                <select id="newStudentGrade">
                    <option value="Ø§ÙˆÙ„">Ø§ÙˆÙ„</option>
                    <option value="Ø¯ÙˆÙ…">Ø¯ÙˆÙ…</option>
                    <option value="Ø³ÙˆÙ…">Ø³ÙˆÙ…</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ú©Ù„Ø§Ø³:</label>
                <select id="newStudentClass">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ù…Ø¹Ù„Ù…:</label>
                <input type="text" id="newStudentTeacher" placeholder="Ù†Ø§Ù… Ù…Ø¹Ù„Ù… (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
            </div>
            <div id="addStudentMessage" class="hidden"></div>
            <div class="button-group">
                <button class="btn btn-success" onclick="addStudent()">Ø«Ø¨Øª</button>
                <button class="btn btn-secondary btn-small" onclick="showManagerPanel()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            </div>
        </div>
    </div>

    <script>
        // âš ï¸ Ù…Ù‡Ù…: URL Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Google Apps Script Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
        const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxakeXcqEOHcuGVmsIWc2udlNbMFmc04lIvoLrx2-V4bR78afSsUFcdAf9bUAVFgRQMnw/exec';
        
        let students = [];
        let currentAbsent = new Set();

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ø§Ø² Google Sheets
        window.addEventListener('load', () => {
            fetchStudents();
        });

        // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Google Sheets
        async function callAPI(action, data = {}) {
            try {
                const response = await fetch(SHEET_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({action, ...data})
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±:', error);
                return {success: false, message: 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±'};
            }
        }

        // Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†
        async function fetchStudents() {
            const result = await callAPI('getStudents');
            if (result.success && result.data) {
                students = result.data;
            }
        }

        function showHome() {
            hideAll();
            document.getElementById('homePage').classList.remove('hidden');
        }

        function showTeacherPanel() {
            hideAll();
            document.getElementById('teacherPanel').classList.remove('hidden');
        }

        function showManagerLogin() {
            hideAll();
            document.getElementById('managerLogin').classList.remove('hidden');
            document.getElementById('managerPassword').value = '';
            document.getElementById('loginError').classList.add('hidden');
        }

        function showManagerPanel() {
            hideAll();
            document.getElementById('managerPanel').classList.remove('hidden');
        }

        function showDailyReport() {
            hideAll();
            document.getElementById('dailyReport').classList.remove('hidden');
            loadDailyReport();
        }

        function showFullReport() {
            hideAll();
            document.getElementById('fullReport').classList.remove('hidden');
        }

        function showSearchPanel() {
            hideAll();
            document.getElementById('searchPanel').classList.remove('hidden');
        }

        function showAddStudent() {
            hideAll();
            document.getElementById('addStudentPanel').classList.remove('hidden');
        }

        function hideAll() {
            const pages = ['homePage', 'managerLogin', 'teacherPanel', 'managerPanel', 
                          'dailyReport', 'fullReport', 'searchPanel', 'addStudentPanel'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
        }

        function checkManagerPassword() {
            const password = document.getElementById('managerPassword').value;
            if (password === '2225') {
                showManagerPanel();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function loadStudents() {
            const grade = document.getElementById('gradeSelect').value;
            const classNum = document.getElementById('classSelect').value;
            
            if (!grade || !classNum) return;

            const filtered = students.filter(s => s.grade === grade && s.class === classNum);
            
            // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ
            filtered.sort((a, b) => a.family.localeCompare(b.family, 'fa'));
            
            const listDiv = document.getElementById('studentList');
            currentAbsent.clear();
            
            // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„Ø§Ø³ (Ù…Ø¹Ù„Ù… Ùˆ ØªØ¹Ø¯Ø§Ø¯)
            getClassInfo(grade, classNum);
            
            if (filtered.length === 0) {
                listDiv.innerHTML = '<p class="message info">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ú©Ù„Ø§Ø³ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
                return;
            }
            
            listDiv.innerHTML = filtered.map((s, i) => `
                <div class="student-item">
                    <span class="student-name">${i + 1}. ${s.name} ${s.family}</span>
                    <button class="emoji-btn" id="emoji${i}" onclick="toggleAbsent(${i}, '${s.name}', '${s.family}')">ğŸ™‹â€â™‚ï¸</button>
                </div>
            `).join('');
        }

        // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„Ø§Ø³
        async function getClassInfo(grade, classNum) {
            const result = await callAPI('getClassInfo', {grade, class: classNum});
            
            if (result.success && result.data) {
                const teacherInput = document.getElementById('teacherName');
                const classInfo = document.getElementById('classInfo');
                const studentCount = document.getElementById('studentCount');
                
                teacherInput.value = result.data.teacher || '';
                studentCount.textContent = result.data.studentCount;
                classInfo.classList.remove('hidden');
            }
        }

        function toggleAbsent(index, name, family) {
            const btn = document.getElementById('emoji' + index);
            const key = name + ' ' + family;
            
            if (currentAbsent.has(key)) {
                currentAbsent.delete(key);
                btn.textContent = 'ğŸ™‹â€â™‚ï¸';
                btn.classList.remove('absent');
            } else {
                currentAbsent.add(key);
                btn.textContent = 'ğŸ™';
                btn.classList.add('absent');
            }
        }

        async function noAbsent() {
            const grade = document.getElementById('gradeSelect').value;
            const classNum = document.getElementById('classSelect').value;
            const teacher = document.getElementById('teacherName').value;

            if (!grade || !classNum || !teacher) {
                showMessage('teacherMessage', 'Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
            document.getElementById('noAbsentBtn').disabled = true;
            document.getElementById('submitBtn').disabled = true;

            // Ø¨Ø±Ø±Ø³ÛŒ Ø«Ø¨Øª ØªÚ©Ø±Ø§Ø±ÛŒ
            const today = new Date().toLocaleDateString('fa-IR');
            const checkResult = await callAPI('checkDuplicateSubmission', {
                date: today,
                grade: grade,
                class: classNum
            });

            if (checkResult.data && checkResult.data.isDuplicate) {
                showMessage('teacherMessage', 'Ú©Ù„Ø§Ø³ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡ØŒ Ø¨Ø§ Ù…Ø¯ÛŒØ± Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ú©Ù†ÛŒØ¯', 'error');
                document.getElementById('noAbsentBtn').disabled = false;
                document.getElementById('submitBtn').disabled = false;
                return;
            }

            // Ø«Ø¨Øª ØºÛŒØ¨Øª Ø¨Ø¯ÙˆÙ† ØºØ§ÛŒØ¨
            const result = await callAPI('submitAbsence', {
                date: today,
                grade: grade,
                class: classNum,
                teacher: teacher,
                time: new Date().toLocaleTimeString('fa-IR'),
                students: []
            });

            if (result.success) {
                showMessage('teacherMessage', 'ØºÛŒØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ (ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…) âœ…', 'success');
                setTimeout(() => {
                    showHome();
                }, 2000);
            } else {
                showMessage('teacherMessage', result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª', 'error');
                document.getElementById('noAbsentBtn').disabled = false;
                document.getElementById('submitBtn').disabled = false;
            }
        }

        async function submitAbsence() {
            const grade = document.getElementById('gradeSelect').value;
            const classNum = document.getElementById('classSelect').value;
            const teacher = document.getElementById('teacherName').value;

            if (!grade || !classNum || !teacher) {
                showMessage('teacherMessage', 'Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            if (currentAbsent.size === 0) {
                showMessage('teacherMessage', 'Ù„Ø·ÙØ§ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† ØºØ§ÛŒØ¨ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯ ÛŒØ§ "ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…" Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
            document.getElementById('noAbsentBtn').disabled = true;
            document.getElementById('submitBtn').disabled = true;

            // Ø¨Ø±Ø±Ø³ÛŒ Ø«Ø¨Øª ØªÚ©Ø±Ø§Ø±ÛŒ
            const today = new Date().toLocaleDateString('fa-IR');
            const checkResult = await callAPI('checkDuplicateSubmission', {
                date: today,
                grade: grade,
                class: classNum
            });

            if (checkResult.data && checkResult.data.isDuplicate) {
                showMessage('teacherMessage', 'Ú©Ù„Ø§Ø³ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡ØŒ Ø¨Ø§ Ù…Ø¯ÛŒØ± Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ú©Ù†ÛŒØ¯', 'error');
                document.getElementById('noAbsentBtn').disabled = false;
                document.getElementById('submitBtn').disabled = false;
                return;
            }

            // Ø«Ø¨Øª ØºÛŒØ¨Øª
            const result = await callAPI('submitAbsence', {
                date: today,
                grade: grade,
                class: classNum,
                teacher: teacher,
                time: new Date().toLocaleTimeString('fa-IR'),
                students: Array.from(currentAbsent)
            });

            if (result.success) {
                showMessage('teacherMessage', 'ØºÛŒØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ âœ…', 'success');
                setTimeout(() => {
                    showHome();
                }, 2000);
            } else {
                showMessage('teacherMessage', result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª', 'error');
                document.getElementById('noAbsentBtn').disabled = false;
                document.getElementById('submitBtn').disabled = false;
            }
        }

        function showMessage(elementId, text, type) {
            const msg = document.getElementById(elementId);
            msg.textContent = text;
            msg.className = 'message ' + type;
            msg.classList.remove('hidden');
        }

        async function loadDailyReport() {
            const contentDiv = document.getElementById('dailyReportContent');
            contentDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p></div>';

            const today = new Date().toLocaleDateString('fa-IR');
            const result = await callAPI('getDailyAbsences', {date: today});

            if (!result.success || !result.data || result.data.length === 0) {
                contentDiv.innerHTML = '<p class="message info">Ø§Ù…Ø±ÙˆØ² ØºÛŒØ¨ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
                return;
            }

            const todayAbsences = result.data;

            // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø§ÛŒÙ‡ Ùˆ Ú©Ù„Ø§Ø³
            todayAbsences.sort((a, b) => {
                const gradeOrder = {Ø§ÙˆÙ„: 1, Ø¯ÙˆÙ…: 2, Ø³ÙˆÙ…: 3};
                if (gradeOrder[a.grade] !== gradeOrder[b.grade]) {
                    return gradeOrder[a.grade] - gradeOrder[b.grade];
                }
                return parseInt(a.class) - parseInt(b.class);
            });

            let html = '<div style="line-height: 2;">';
            
            todayAbsences.forEach((a) => {
                const genderIcon = a.teacher.includes('Ø®Ø§Ù†Ù…') || a.teacher.includes('ÙØ§Ø·Ù…Ù‡') || 
                                  a.teacher.includes('Ø²Ù‡Ø±Ø§') || a.teacher.includes('Ù…Ø±ÛŒÙ…') || 
                                  a.teacher.includes('Ø³Ø§Ø±Ø§') || a.teacher.includes('Ù…ÛŒÙ†Ø§') || 
                                  a.teacher.includes('Ù†Ø±Ú¯Ø³') || a.teacher.includes('Ø§Ù„Ù‡Ø§Ù…') ? 'ğŸ‘©â€ğŸ«' : 'ğŸ‘¨â€ğŸ«';
                
                // Ø®Ø· Ø§ÙˆÙ„: Ù¾Ø§ÛŒÙ‡ØŒ Ú©Ù„Ø§Ø³ØŒ Ù…Ø¹Ù„Ù… Ùˆ Ø³Ø§Ø¹Øª
                html += `<div style="background: linear-gradient(135deg, #FF6B9D 0%, #C06C84 100%); 
                         color: white; padding: 12px; border-radius: 10px; margin: 15px 0; 
                         font-weight: bold; font-size: 16px;">`;
                html += `Ù¾Ø§ÛŒÙ‡ ${a.grade} ${a.class} - ${genderIcon} ${a.teacher} - Ø³Ø§Ø¹Øª ${a.time}`;
                html += `</div>`;
                
                // Ù„ÛŒØ³Øª ØºØ§ÛŒØ¨ÛŒÙ†
                if (a.students.length > 0) {
                    html += `<div style="padding: 10px 20px; background: #f9f9f9; 
                             border-radius: 8px; margin-bottom: 10px;">`;
                    a.students.forEach((s, i) => {
                        html += `<div style="padding: 5px 0;">${i + 1}. ${s}</div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div style="padding: 15px 20px; background: #d4edda; 
                             border-radius: 8px; margin-bottom: 10px; color: #155724; 
                             font-weight: bold; text-align: center;">`;
                    html += `âœ… ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…`;
                    html += `</div>`;
                }
            });
            
            html += '</div>';
            
            // Ø¬Ù…Ø¹ Ú©Ù„
            const totalAbsent = todayAbsences.reduce((sum, a) => sum + a.students.length, 0);
            html += `<div style="background: #FFE66D; padding: 15px; border-radius: 10px; 
                     text-align: center; font-weight: bold; margin-top: 20px; font-size: 18px;">`;
            html += `ğŸ“Š Ø¬Ù…Ø¹ Ú©Ù„ ØºØ§ÛŒØ¨ÛŒÙ†: ${totalAbsent} Ù†ÙØ±`;
            html += `</div>`;

            contentDiv.innerHTML = html;
        }

        async function copyReport() {
            const today = new Date().toLocaleDateString('fa-IR');
            const result = await callAPI('getDailyAbsences', {date: today});
            
            if (!result.success || !result.data || result.data.length === 0) {
                alert('Ú¯Ø²Ø§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
                return;
            }

            const todayAbsences = result.data;

            // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø§ÛŒÙ‡ Ùˆ Ú©Ù„Ø§Ø³
            todayAbsences.sort((a, b) => {
                const gradeOrder = {Ø§ÙˆÙ„: 1, Ø¯ÙˆÙ…: 2, Ø³ÙˆÙ…: 3};
                if (gradeOrder[a.grade] !== gradeOrder[b.grade]) {
                    return gradeOrder[a.grade] - gradeOrder[b.grade];
                }
                return parseInt(a.class) - parseInt(b.class);
            });
            
            let text = `ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ ØºÛŒØ¨Øª Ù…Ø¯Ø±Ø³Ù‡ Ø´Ù‡ÛŒØ¯ Ù†ÛŒØ§Ø³Ø±ÛŒ\n`;
            text += `ğŸ“… ØªØ§Ø±ÛŒØ®: ${today}\n`;
            text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
            
            let totalAbsent = 0;
            
            todayAbsences.forEach((a) => {
                const genderIcon = a.teacher.includes('Ø®Ø§Ù†Ù…') || a.teacher.includes('ÙØ§Ø·Ù…Ù‡') || 
                                  a.teacher.includes('Ø²Ù‡Ø±Ø§') || a.teacher.includes('Ù…Ø±ÛŒÙ…') || 
                                  a.teacher.includes('Ø³Ø§Ø±Ø§') || a.teacher.includes('Ù…ÛŒÙ†Ø§') || 
                                  a.teacher.includes('Ù†Ø±Ú¯Ø³') || a.teacher.includes('Ø§Ù„Ù‡Ø§Ù…') ? 'ğŸ‘©â€ğŸ«' : 'ğŸ‘¨â€ğŸ«';
                
                text += `Ù¾Ø§ÛŒÙ‡ ${a.grade} ${a.class} - ${genderIcon} ${a.teacher} - Ø³Ø§Ø¹Øª ${a.time}\n`;
                
                // Ù„ÛŒØ³Øª ØºØ§ÛŒØ¨ÛŒÙ† ÛŒØ§ ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…
                if (a.students.length > 0) {
                    totalAbsent += a.students.length;
                    a.students.forEach((s, i) => {
                        text += `${i + 1}. ${s}\n`;
                    });
                } else {
                    text += `âœ… ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…\n`;
                }
                
                text += `\n`; // ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ù¾Ø§ÛŒÙ‡â€ŒÙ‡Ø§
            });
            
            text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            text += `ğŸ“Š Ø¬Ù…Ø¹ Ú©Ù„ ØºØ§ÛŒØ¨ÛŒÙ†: ${totalAbsent} Ù†ÙØ±`;

            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('âœ… Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ù¾ÛŒ Ø´Ø¯!');
                }).catch(err => {
                    fallbackCopyText(text);
                });
            } else {
                fallbackCopyText(text);
            }
        }

        function fallbackCopyText(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert('âœ… Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ù¾ÛŒ Ø´Ø¯!');
            } catch (err) {
                alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†');
            }
            document.body.removeChild(textArea);
        }

        async function loadFullReport() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const contentDiv = document.getElementById('fullReportContent');

            if (!fromDate || !toDate) {
                contentDiv.innerHTML = '<p class="message error">Ù„Ø·ÙØ§ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>';
                return;
            }

            contentDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p></div>';

            const result = await callAPI('getAbsencesByDate', {
                fromDate: fromDate,
                toDate: toDate
            });

            if (!result.success || !result.data || result.data.length === 0) {
                contentDiv.innerHTML = '<p class="message info">Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ ØºÛŒØ¨ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
                return;
            }

            let html = '<div style="line-height: 2;">';
            
            result.data.forEach((a) => {
                const genderIcon = a.teacher.includes('Ø®Ø§Ù†Ù…') || a.teacher.includes('ÙØ§Ø·Ù…Ù‡') || 
                                  a.teacher.includes('Ø²Ù‡Ø±Ø§') || a.teacher.includes('Ù…Ø±ÛŒÙ…') || 
                                  a.teacher.includes('Ø³Ø§Ø±Ø§') || a.teacher.includes('Ù…ÛŒÙ†Ø§') || 
                                  a.teacher.includes('Ù†Ø±Ú¯Ø³') || a.teacher.includes('Ø§Ù„Ù‡Ø§Ù…') ? 'ğŸ‘©â€ğŸ«' : 'ğŸ‘¨â€ğŸ«';
                
                html += `<div style="background: linear-gradient(135deg, #FF6B9D 0%, #C06C84 100%); 
                         color: white; padding: 12px; border-radius: 10px; margin: 15px 0; 
                         font-weight: bold; font-size: 16px;">`;
                html += `${a.date} - Ù¾Ø§ÛŒÙ‡ ${a.grade} ${a.class} - ${genderIcon} ${a.teacher} - Ø³Ø§Ø¹Øª ${a.time}`;
                html += `</div>`;
                
                if (a.students.length > 0) {
                    html += `<div style="padding: 10px 20px; background: #f9f9f9; 
                             border-radius: 8px; margin-bottom: 10px;">`;
                    a.students.forEach((s, i) => {
                        html += `<div style="padding: 5px 0;">${i + 1}. ${s}</div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div style="padding: 15px 20px; background: #d4edda; 
                             border-radius: 8px; margin-bottom: 10px; color: #155724; 
                             font-weight: bold; text-align: center;">`;
                    html += `âœ… ØºØ§ÛŒØ¨ Ù†Ø¯Ø§Ø±ÛŒÙ…`;
                    html += `</div>`;
                }
            });
            
            html += '</div>';
            contentDiv.innerHTML = html;
        }

        async function searchStudent() {
            const searchName = document.getElementById('searchName').value.trim();
            const resultDiv = document.getElementById('searchResult');
            
            if (!searchName) {
                resultDiv.innerHTML = '<p class="message error">Ù„Ø·ÙØ§ Ù†Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>';
                return;
            }

            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...</p></div>';

            const result = await callAPI('searchStudent', {name: searchName});

            if (!result.success || !result.data || result.data.length === 0) {
                resultDiv.innerHTML = '<p class="message info">ØºÛŒØ¨ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
                return;
            }

            let html = `<div style="background: #FFE66D; padding: 15px; border-radius: 10px; 
                        text-align: center; font-weight: bold; margin: 20px 0;">`;
            html += `ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ ØºÛŒØ¨Øª: ${result.data.length} Ø±ÙˆØ²`;
            html += `</div>`;
            
            html += '<div style="line-height: 1.8;">';
            result.data.forEach((a, i) => {
                html += `<div style="padding: 10px; background: #f9f9f9; 
                         border-radius: 8px; margin: 10px 0; border-right: 4px solid #FF6B9D;">`;
                html += `<strong>${i + 1}.</strong> ØªØ§Ø±ÛŒØ®: ${a.date} - Ù¾Ø§ÛŒÙ‡ ${a.grade} Ú©Ù„Ø§Ø³ ${a.class}`;
                html += `</div>`;
            });
            html += '</div>';

            resultDiv.innerHTML = html;
        }

        async function addStudent() {
            const name = document.getElementById('newStudentName').value.trim();
            const family = document.getElementById('newStudentFamily').value.trim();
            const grade = document.getElementById('newStudentGrade').value;
            const classNum = document.getElementById('newStudentClass').value;
            const teacher = document.getElementById('newStudentTeacher').value.trim();

            if (!name || !family) {
                showMessage('addStudentMessage', 'Ù„Ø·ÙØ§ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
                return;
            }

            const result = await callAPI('addStudent', {
                name: name,
                family: family,
                grade: grade,
                class: classNum,
                teacher: teacher
            });

            if (result.success) {
                showMessage('addStudentMessage', 'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ âœ…', 'success');
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ù…Ø­Ù„ÛŒ
                students.push({name, family, grade, class: classNum, teacher});
                
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§
                document.getElementById('newStudentName').value = '';
                document.getElementById('newStudentFamily').value = '';
                document.getElementById('newStudentTeacher').value = '';
                
                setTimeout(() => {
                    document.getElementById('addStudentMessage').classList.add('hidden');
                }, 3000);
            } else {
                showMessage('addStudentMessage', result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª', 'error');
            }
        }
    </script>
</body>
</html>